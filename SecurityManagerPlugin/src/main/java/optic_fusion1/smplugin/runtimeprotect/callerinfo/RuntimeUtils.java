package optic_fusion1.smplugin.runtimeprotect.callerinfo;

import java.io.File;
import java.net.URISyntaxException;
import java.util.Objects;
import static optic_fusion1.smplugin.SecurityManager.LOGGER;
import static optic_fusion1.smplugin.SecurityManager.PLUGIN_INDEX;
import optic_fusion1.smplugin.runtimeprotect.IndexedPlugin;

public final class RuntimeUtils {

  private RuntimeUtils() {
  }

  public static File getSourceJar(Class clazz) {
    try {
      return new File(Objects.requireNonNull(clazz, "clazz is null").getProtectionDomain().getCodeSource().getLocation()
              .toURI());
    } catch (URISyntaxException ex) {
      LOGGER.exception(ex);
    }
    return null;
  }

  public static CallerInfo getCallerInfo() {
    StackTraceElement[] stacktrace = Thread.currentThread().getStackTrace();
    for (StackTraceElement e : stacktrace) {
      String callerClassName = e.getClassName();
      IndexedPlugin plugin = PLUGIN_INDEX.getClassOwner(callerClassName);
      if (plugin != null && !plugin.getJar().getName().equals("MCAntiMalware.jar")) {
        return new CallerInfo(plugin, callerClassName, e.getMethodName());
      }
    }

    return null;
  }
}
